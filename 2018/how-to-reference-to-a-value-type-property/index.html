<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 如何引用一个值类型属性 · Inti's Blog</title><meta name="description" content="如何引用一个值类型属性 - Inti Guo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="search" type="application/opensearchdescription+xml" href="http://intii.com/atom.xml" title="Inti's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link shake"><img src="/Logo.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="https://twitter.com/int123c" target="_blank" class="nav-list-link">ABOUT</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">如何引用一个值类型属性</h1><div class="post-info">Apr 2, 2018</div><div class="post-content"><p>在更新 Best Before 的过程中，我决定重写 <code>ForwardStrategy</code> 的部分。过去 <code>ForwardStrategy</code> 中不同的转发目标所储存的信息其实是一样的，只是不同的转发目标会隐藏其不包含的属性。因此其对应的表单也是这样设计的，表单中其实包含了所有属性对应的 cell，但是在选中某些目标时，其中一些 cell 被隐藏起来了。</p>
<p>举个例子吧：比如说我们有 Things 和 Mail 两种转发目标，当我们选中 Things 时，因为它并没有收件人，所以其对应的 cell 被隐藏起来了。当我们切换到 Mail，收件人就得以重见天日，但截止日期却被隐藏起来了。这个方案当然是 work 的，但是却有一个明显的缺点，一旦我们需要添加新的转发目标，或更新旧有的转发目标时出现了新的属性时，我们就需要修改模型，并在表单中增加新的 cell 了。</p>
<p>因此在这次更新中，我决定将转发目标的属性以 JSON 为格式储存，这也避免了不同转发目标混用属性的尴尬。表单方面也需要作出修改。窒息观察可以发现，这些属性有几个固定的类型：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ForwardFormElement</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> highlightTextView(title: <span class="type">String</span>, placeholder: <span class="type">String</span>?, bind: <span class="type">PropertyRefTo</span>&lt;<span class="type">String</span>&gt;)</div><div class="line">    <span class="keyword">case</span> textView(title: <span class="type">String</span>, placeholder: <span class="type">String</span>?, bind: <span class="type">PropertyRefTo</span>&lt;<span class="type">String</span>&gt;)</div><div class="line">    <span class="keyword">case</span> textField(title: <span class="type">String</span>, placeholder: <span class="type">String</span>?, keyboardType: <span class="type">UIKeyboardType</span>, bind: <span class="type">PropertyRefTo</span>&lt;<span class="type">String</span>&gt;)</div><div class="line">    <span class="keyword">case</span> picker(title: <span class="type">String</span>, options: [<span class="type">String</span>], bind: <span class="type">PropertyRefTo</span>&lt;<span class="type">Int</span>&gt;)</div><div class="line">    <span class="keyword">case</span> toggle(title: <span class="type">String</span>, bind: <span class="type">PropertyRefTo</span>&lt;<span class="type">Bool</span>&gt;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们只需要提供每一种转发目标的 <code>[ForwardFormElement]</code>，就能依次利用 Form Builder 生成相应的表单了。同时也为了契合我在用的 Form Builder 的特点，我希望在生成每一个 <code>Row</code> 时能够通过它的 <code>onChange</code> 方法将变动绑定到转发目标的相关属性上。这才有了本篇文章的主题。</p>
<a id="more"></a>
<p>先梳理一下，我希望的结果是：</p>
<ol>
<li>转发目标提供 <code>[ForwardFormElement]</code> 给 Form Builder</li>
<li>ForwardFormElement 中包含了一个对转发目标属性的弱引用</li>
<li>Form Builder 生成 <code>Row</code> 时通过 <code>onChange</code> 方法绑定属性<br> <code>row.onChange { bind.val = $0 }</code></li>
<li><code>bind.val</code> 改变时同时改变转发目标的相关属性（很可能是值类型）</li>
</ol>
<p>那么接下来就是怎么实现 <code>bind: PropertyRefTo&lt;T&gt;</code> 的问题了。</p>
<p>很简单，Swift 4 给我们带来了 KeyPath subscription，只要我们持有转发目标的弱引用，然后再存对应的 KeyPath 就好了。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertyRefTo</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">var</span> val: <span class="type">V</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertyRef</span>&lt;<span class="title">O</span>: <span class="title">AnyObject</span>, <span class="title">V</span>&gt;: <span class="title">PropertyRefTo</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">weak</span> <span class="keyword">var</span> object: <span class="type">O</span>?</div><div class="line">    <span class="keyword">let</span> keyPath: <span class="type">ReferenceWritableKeyPath</span>&lt;<span class="type">O</span>, <span class="type">V</span>&gt;</div><div class="line">    </div><div class="line">    <span class="keyword">init</span>(<span class="number">_</span> object: <span class="type">O</span>, <span class="number">_</span> keyPath: <span class="type">ReferenceWritableKeyPath</span>&lt;<span class="type">O</span>, <span class="type">V</span>&gt;) &#123;</div><div class="line">        <span class="keyword">self</span>.object = object</div><div class="line">        <span class="keyword">self</span>.keyPath = keyPath</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="keyword">var</span> val: <span class="type">V</span>? &#123;</div><div class="line">        <span class="keyword">get</span> &#123;</div><div class="line">            <span class="keyword">return</span> object?[keyPath: keyPath]</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">set</span> &#123;</div><div class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> v = newValue <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">            object?[keyPath: keyPath] = v</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>能用吗？能用。但是我还有一个额外的需求，有一些对应 <code>case picker(title: String, options: [String], bind: PropertyRefTo&lt;Int&gt;)</code> 的属性是 Enum，但 Swift 并没有 Generic Case 这样的东西，所以我们要让 <code>PropertyRef</code> 能够按照我们的要求将其 <code>val</code> 转换成我们需要的类型。显而易见，不提供 <code>object</code> 和 <code>keyPath</code>，而是提供 <code>val</code> 的 getter 和 setter 不就好了吗。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">init</span>(<span class="number">_</span> object: <span class="type">O</span>, getter: @escaping (<span class="type">O</span>)-&gt;<span class="type">V</span>?, setter: @escaping (<span class="type">O</span>, <span class="type">V</span>)-&gt;<span class="type">Void</span>) &#123;</div><div class="line">    <span class="keyword">self</span>.getter = &#123;</div><div class="line">        [<span class="keyword">weak</span> object] <span class="keyword">in</span> <span class="keyword">guard</span> <span class="keyword">let</span> object = object <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</div><div class="line">        <span class="keyword">return</span> getter(object)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">self</span>.setter = &#123;</div><div class="line">        [<span class="keyword">weak</span> object] newValue <span class="keyword">in</span> <span class="keyword">guard</span> <span class="keyword">let</span> object = object <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">        setter(object, newValue)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们在 block 里通过 capture list 弱引用 <code>object</code>，因为这么写了，所以我们要求 <code>O: AnyObject</code>。最后 Key Path 这种这么方便的东西，我们也可以提供一个 convenience initializer。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">convenience</span> <span class="keyword">init</span>(<span class="number">_</span> object: <span class="type">O</span>, <span class="number">_</span> keyPath: <span class="type">ReferenceWritableKeyPath</span>&lt;<span class="type">O</span>, <span class="type">V</span>&gt;) &#123;</div><div class="line">    <span class="keyword">self</span>.<span class="keyword">init</span>(object, getter: &#123; $<span class="number">0</span>[keyPath: keyPath] &#125;, setter: &#123; $<span class="number">0</span>[keyPath: keyPath] = $<span class="number">1</span> &#125; )</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此我们就能获得一个 <code>AnyObject</code> 的非引用类型的属性的引用啦。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/decorate-uinavigationbar-with-blend-mode/" class="next">Next Post →</a></div><div class="copyright"><p>© 2012 - 2018, handcrafted under ☁︎ in the city of knockoffs.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create',"UA-17603222-1",'auto');ga('send','pageview');</script></body></html>