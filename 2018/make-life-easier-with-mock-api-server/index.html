<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 写一个 Mock API Server 让生活更简单 · INTITNI BLOG</title><meta name="description" content="写一个 Mock API Server 让生活更简单 - Shangxin Guo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><link rel="search" type="application/opensearchdescription+xml" href="http://intii.com/atom.xml" title="INTITNI BLOG"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="wrap"><header><a href="/" class="logo-link shake"><img src="/Logo.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="https://twitter.com/intitni" target="_blank" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/intitni" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">写一个 Mock API Server 让生活更简单</h1><div class="post-info">Aug 18, 2018</div><div class="post-content"><p>公司项目的业务逻辑蛮复杂的，有时候我们需要测试 UI，就得让订单达到某一个特定的状态，往往需要在后台里先点个几分钟。其实最后我们还不是拿的后端返回的数据来填充 UI，所以为什么不直接把这个状态的数据构造好，直接拿来使用呢？所以我还是决定写个 Mock Server。</p>
<p>Mock Server 的功能很简单：</p>
<ol>
<li>根据 API Endpoint，返回配置文件中指定的 JSON 文件；</li>
<li>可以局部匹配参数，返回指定的 JSON 文件。</li>
</ol>
<p>后来 Android 端的小伙伴似乎也有点兴趣，但不想总是改代码指向 Mock Server，那行，我们就再加一个功能：<strong>3. 配置文件中没有指定的接口的请求，转发到开发服务器中。</strong></p>
<a id="more"></a>
<p>前两部分很简单，就是写一个 API Server 而已。因为懒得碰其它语言，直接使用了 Swift + Vapor。每次收到请求，我们都读取一下配置文件，大概是这么个结构：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Pref</span>: <span class="title">Decodable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> endpoints: [<span class="type">Endpoint</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Endpoint</span>: <span class="title">Decodable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> endpoint: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> filename: <span class="type">String</span>?</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">let</span> dispatch: [<span class="type">Dispatcher</span>]?</span><br><span class="line">	</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Dispatcher</span>: <span class="title">Decodable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> parameters: <span class="type">JSONValue</span></span><br><span class="line">        <span class="keyword">let</span> filename: <span class="type">String</span></span><br><span class="line">		</span><br><span class="line">        <span class="function"><span class="keyword">func</span> <span class="title">match</span><span class="params">(<span class="number">_</span> param: JSONValue)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> parameters.compare(param)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得请求后，我们首先判断接口是否在 <code>Pref.endpoints</code> 中，如果有，则在看其参数是否存在一个子集处于 <code>Endpoint.dispatch</code> 中，如果有则使用其中的 <code>filename</code>.json，没有则 Fallback 到 <code>Endpoint.filename</code>.json。</p>
<p>对于其它的一切情况，返回 404。</p>
<p>第三点就比较麻烦了，一开始我想在 Mock Server 里再发一次请求，尽管咨询了后端的同学，但最终还是遇到了一些我暂时解决不了的问题：</p>
<ol>
<li>多个请求同时来的时候会收不到一些响应；</li>
<li>用 Nginx 实现 HTTPS 的时候，响应会变成双倍。但 Vapor 3 直接实现 HTTPS，找遍了 Google 都没找到方法。</li>
</ol>
<p>我倒腾了很久都没搞懂是什么情况……最后 Google 发现 Nginx 有一个东西叫做 <code>proxy_next_upstream</code>，我们可以指定多个 Upstream，如果一个有问题，就用下一个。所以我们可以写下这样的 Upstream：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> w &#123;</span><br><span class="line">    <span class="attribute">server</span> localhost:4343 max_fails=0 weight=200;</span><br><span class="line">    <span class="attribute">server</span> real.dev.api.server.com:443 max_fails=0 weight=1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>值得注意的是要写下权重，避免 Nginx 轮询调用。</p>
<p>然后再写两个 Server：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server</span> &#123; #A</span><br><span class="line">    <span class="attribute"><span class="nomarkup">listen</span></span>       80;</span><br><span class="line">    <span class="attribute"><span class="nomarkup">listen</span></span>       443 ssl;</span><br><span class="line">    <span class="attribute">server_name</span>  real.dev.api.server.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> servernew.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> server.key;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_session_cache</span>    shared:SSL:1m;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span>  5m;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> https://w;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host real.dev.api.server.com;</span><br><span class="line">        <span class="attribute">proxy_next_upstream</span> error timeout http_500 http_502 http_503 http_504 http_404 invalid_header non_idempotent;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">server</span> &#123; #B</span><br><span class="line">    <span class="attribute"><span class="nomarkup">listen</span></span>       4343 ssl;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> servernew.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> server.key;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:9090;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host real.dev.api.server.com;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如此一来，通过改 Host 或改代码指向本机 IP 的方式，我们就能通过 Server#A 先调用 Mock Server，如果配置文件中没有请求的接口，则返回 404，接着调用真实的开发环境接口。</p>
<p>Server#B 是因为 Server#A 的 <code>proxy_pass</code> 用的是 <code>https</code>，试了一下有问题，所以又做了一层。我并不清楚以上哪一行是多余的，反正能用（</p>
<p>现在我们就能无痛使用 Mock Server 获得假数据了。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/new-avatar-slime-not-evil/" class="prev">← Previous Post</a><a href="/2018/write-api-client-with-sourcery/" class="next">Next Post →</a></div><div id="container"></div><div id="disqus_thread"></div><script>var disqus_shortname = 'intii-com';
var disqus_identifier = '2018/make-life-easier-with-mock-api-server/';
var disqus_title = '写一个 Mock API Server 让生活更简单';
var disqus_url = 'http://intii.com/2018/make-life-easier-with-mock-api-server/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//intii-com.disqus.com/count.js" async></script><div class="copyright"><p>© 2012 - 2020, handcrafted under ☁︎ in the city of knockoffs.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create',"UA-17603222-1",'auto');ga('send','pageview');</script></body></html>